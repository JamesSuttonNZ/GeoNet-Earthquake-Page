<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
<style>
@media screen and (max-width: 992px) {
	.geonetrow {
		flex-direction: column-reverse;
	}
}
</style>
</head>
<body>

	<div style="width: 100%;">
	
	<label for="Earthquakes">Intensity:</label>

	<select id="Earthquakes" onchange="setMMI(this)"> 
		<option value="all">All (includes deleted)</option>
		<option value="weak" selected="">Weak+</option>
		<option value="light">Light+</option>
		<option value="moderate">Moderate+</option>
		<option value="strong">Strong+</option>
		<option value="severe">Severve+</option>
	</select>
	
	<br>
	
	<label for="Time">Time:</label>

	<select id="Time" onchange="setStartDate(this)"> 
		<option value="hour">Past Hour</option>
		<option value="24hour">Past 24 Hours</option>
		<option value="week">Past Week</option>
		<option value="month">Past Month</option>
		<option value="year" selected="">Past Year</option>
	</select>
	
	<br>
	
	<label for="Max">Max:</label>

	<select id="Max" onchange="setMax(this)"> 
		<option value="5">5</option>
		<option value="10">10</option>
		<option value="25">25</option>
		<option value="50">50</option>
		<option value="100" selected="">100</option>
	</select>
	
	<br>
	
	<label for="Colour By">Colour By:</label>

	<select id="Colour By" onchange="setColourScheme(this)"> 
		<option value="0" selected="">Magnitude</option>
		<option value="1">Intensity(MMI)</option>
	</select>
	
	<!--Can't use this is api only returns last 100 quakes not all quakes from last 365 days
	<label for="dateStart">Start Date:</label>
	<input type="date" id="dateStart" name="dateStart" onchange="setStartDate(this)" onkeydown="return false">

	<label for="dateEnd">End Date:</label>
	<input type="date" id="dateEnd" name="dateEnd" onchange="setEndDate(this)" onkeydown="return false">*/
	-->
	
	<p id="desc"></p>
	
	</div>
	
	<div class="geonetrow" style="display: flex; flex-wrap: nowrap; padding: 10px;">
		<div id="quake data" style="flex: 45%; padding: 10px;"></div>
		
        <div style="flex: 50%; padding: 10px;">
		<div id="map" style="width: 100%px; padding-top: 100%;"></div>
	</div>
    </div>
	
	<script>
	
	//store quake info from api
	var quakes;
	
	//max quake entries shown
	var max = 100;
	
	//set start date
	var startDate = new Date();
	startDate.setFullYear(startDate.getFullYear() - 1);
	var past = "Year"
	
	//initial mmi (weak+)
	var mmi = 3;
	
	var mapImg = new Image();
	
	
	//0 for magnitude, 1 for intensity
	var colourScheme = 0;
	
	function setColourScheme(select){
		if(select.value == "0"){
			colourScheme = 0;
		}
		else if(select.value == "1"){
			colourScheme = 1;
		}
		displayQuakes();
	}
	
	//start date setter function
	function setStartDate(select){
		var d = new Date();
		if(select.value == "hour"){
			d.setHours(d.getHours() - 1);
			startDate = d;
			past = "Hour";
		}
		else if(select.value == "24hour"){
			d.setDate(d.getDate() - 1);
			startDate = d;
			past = "24 Hours";
		}
		else if(select.value == "week"){
			d.setDate(d.getDate() - 7);
			startDate = d;
			past = "Week";
		}
		else if(select.value == "month"){
			d.setMonth(d.getMonth() - 1);
			startDate = d;
			past = "Month";
		}
		else if(select.value == "year"){
			d.setFullYear(d.getFullYear() - 365);
			startDate = d;
			past = "Year";
		}
		displayQuakes();
	}
	
	//max quakes shown setter function
	function setMax(select){
		max = select.value;
		displayQuakes();
	}
	
	//converts date to ISO format
	function convertDate(date){
		var dd = date.getDate();
		var mm = date.getMonth()+1;
		var yyyy = date.getFullYear();
		if(dd<10){
			dd='0'+dd
		} 
		if(mm<10){
			mm='0'+mm
		}
		return yyyy+'-'+mm+'-'+dd;
	}
	
	function lb(){ return document.createElement( 'br' ); }
	
	//return earthquake type string based on MMI
	function getType(mmi){
		if(mmi < 3){
			return "Unnoticeable";
		}
		else if(mmi == 3){
			return "Weak";
		}
		else if(mmi == 4){
			return "Light";
		}
		else if(mmi == 5){
			return "Moderate";
		}
		else if(mmi == 6 || mmi == 7){
			return "Strong";
		}
		else{
			return "Severe";
		}
	}
	
	//set MMI based on dropdown and rerun method to calculate quakes
	function setMMI(select){
		if(select.value == "all"){
			mmi = -1;
		}
		else if(select.value == "weak"){
			mmi = 3;
		}
		else if(select.value == "light"){
			mmi = 4;
		}
		else if(select.value == "moderate"){
			mmi = 5;
		}
		else if(select.value == "strong"){
			mmi = 6;
		}
		else if(select.value == "severe"){
			mmi = 8;
		}
		getQuakes();
	}
	
	//Stores map style settings
	var mapStyle = [{
        'featureType': 'all',
        'elementType': 'all',
        'stylers': [{'visibility': 'off'}]
	}, {
        'featureType': 'landscape',
        'elementType': 'geometry',
        'stylers': [{'visibility': 'on'}, {'color': '#fcfcfc'}]
	}, {
        'featureType': 'water',
        'elementType': 'labels',
        'stylers': [{'visibility': 'off'}]
	}, {
        'featureType': 'water',
        'elementType': 'geometry',
        'stylers': [{'visibility': 'on'}, {'hue': '#5f94ff'}, {'lightness': 60}]
	}];
	
	//main map
	var map;
	//array of markers on map
	var markers = [];
	
	var infoWindow;

	function initMap() {
		
		map = new google.maps.Map(document.getElementById('map'), {
			center: { lat: -40.9006, lng: 174.8860 },
			zoom: 5,
			styles: mapStyle,
			mapTypeId: google.maps.MapTypeId.SATELLITE
		});
		infoWindow = new google.maps.InfoWindow();
		map.addListener('click', function() {
			if (infoWindow) infoWindow.close();
		});
		mapImg.onload = function() { getQuakes();}
		mapImg.src = "nzmap200x200.png";
		
	}
	
	//converts date/time to readable text
	function formatAMPM(date) {
		var hours = date.getHours();
		var minutes = date.getMinutes();
		var ampm = hours >= 12 ? 'PM' : 'AM';
		hours = hours % 12;
		hours = hours ? hours : 12; // the hour '0' should be '12'
		minutes = minutes < 10 ? '0'+minutes : minutes;
		var strTime = hours + ':' + minutes + ' ' + ampm;
		return strTime;
	}

	//calls geonet api and gets/sets all relevant quake data
	async function getQuakes(){
		//get data
		const api_url = 'https://api.geonet.org.nz/quake?MMI='+mmi;
		const response = await fetch(api_url);
		//store data
		const data = await response.json();
		quakes = data.features;
		
		displayQuakes();
	}
	
	function displayQuakes(){
	
		//set description
		var desc = "Earthquakes from the <b>Past "+past+"</b> that may have caused shaking <b>"+getType(mmi)+"</b> or greater in New Zealand. A maximum of <b>"+max+"</b> earthquakes are displayed.";
		document.getElementById("desc").innerHTML = desc;
		
		//set quake data
		var div = document.getElementById("quake data");
		div.innerHTML = "";
		
		//reset markers
		for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
		markers = [];
		
		//array to stores weekday strings
		var weekday = new Array(7);
		weekday[0] = "Sun";
		weekday[1] = "Mon";
		weekday[2] = "Tue";
		weekday[3] = "Wed";
		weekday[4] = "Thu";
		weekday[5] = "Fri";
		weekday[6] = "Sat";
		
		//array to store month strings
		var month = new Array();
		month[0] = "Jan";
		month[1] = "Feb";
		month[2] = "Mar";
		month[3] = "Apr";
		month[4] = "May";
		month[5] = "Jun";
		month[6] = "Jul";
		month[7] = "Aug";
		month[8] = "Sep";
		month[9] = "Oct";
		month[10] = "Nov";
		month[11] = "Dec";
		
		for(var i = 0; i < quakes.length; i++){
		
			//limit entries to max
			if(i == max) break;
			
			//remove entries before startDate
			var t = quakes[i].properties.time;
			var d = new Date(t);
			
			if(d < startDate) break;
			
			//get info
			var time = document.createTextNode(weekday[d.getDay()]+" "+d.getDate()+" "+month[d.getMonth()]+" "+d.getFullYear()+" "+formatAMPM(d));
			var mag = document.createTextNode("Magnitude: "+quakes[i].properties.magnitude.toFixed(1));
			var depth = document.createTextNode("Depth: "+Math.round(quakes[i].properties.depth)+" km");
			var loc = document.createTextNode(quakes[i].properties.locality);
			
			var quakeMMI = quakes[i].properties.mmi;
			
			
			/*console.log(quakes[i].geometry.coordinates);*/
			
			var lat = quakes[i].geometry.coordinates[1];
			var lon = quakes[i].geometry.coordinates[0];
			
			var marker = new google.maps.Marker(styleFeature(quakes[i].properties.magnitude, lat, lon, quakeMMI));
			markers.push(marker);
			
			//row div
			var row = document.createElement("div");
			row.style = "display: flex; flex-wrap: wrap; flex-direction: row;";
			
			//col 1 div colour bar
			var colourBar = document.createElement("div");
			var col = marker.icon.fillColor;
			colourBar.style = "width: 10px;";
			colourBar.style.setProperty('background-color', col);
			
			row.appendChild(colourBar);
			
			//col 2 map canvas
			var opac = marker.icon.fillOpacity;
			var scale = marker.icon.scale;
			
			var topLat = -31.4;
			var botLat = -50.3;
			var latDiff = Math.abs(botLat)-Math.abs(topLat);
			
			var latPer = (Math.abs(lat)-Math.abs(topLat))/latDiff;
			
			var leftLong = 159.9;
			var rightLong = 185.3;
			var longDiff = rightLong-leftLong;
			
			var longPer = (lon-leftLong)/longDiff;
			
			var c = document.createElement("canvas");
			c.width = "200";
			c.height = "200";
			
			var ctx = c.getContext("2d");
			ctx.drawImage(mapImg,0,0);
			ctx.globalAlpha = opac;
			ctx.beginPath();
			ctx.arc(200*longPer,200*latPer,scale,0,2*Math.PI);
			ctx.strokeStyle = "#fff";
			ctx.lineWidth = 0.5;
			ctx.fillStyle = col;
			ctx.fill();
			ctx.globalAlpha = 1;
			ctx.stroke();
			
			//add canvas to div
			row.appendChild(c);
			
			// col 3 div info
			var infoDiv = document.createElement("div");
			infoDiv.style = "padding-left: 10px;";
			
			//heading
			var h = document.createElement("h4");
			var type = document.createTextNode(getType(quakeMMI)+" Earthquake");
			
			var ital = document.createElement("I");
			var italText = document.createTextNode(" ("+calcTimeDiff(d)+")");
			ital.appendChild(italText);
			
            //if(i == 0){
            h.style.cssText = 'margin-top: 0px;';
            //}
			h.appendChild(type);
			h.appendChild(document.createElement("br"));
			h.appendChild(ital);
			infoDiv.appendChild(h)
			
			//info
			var p = document.createElement("p");
			
			p.appendChild(time);
			p.appendChild(lb());
			p.appendChild(mag);
			p.appendChild(lb());
			p.appendChild(depth);
			p.appendChild(lb());
			p.appendChild(loc);
			p.appendChild(lb());
			
			p.style = "margin-bottom: 0px;";
			
			infoDiv.appendChild(p);
			
			row.appendChild(infoDiv);
			
			div.appendChild(row);
			
			div.appendChild(document.createElement("hr"));
			
			var row2 = document.createElement("div");
			row2.style = "display: flex; flex-direction: row;";
			row2.appendChild(colourBar.cloneNode(true));
			row2.appendChild(infoDiv.cloneNode(true));
			
			setMarkerInfo(row2,marker);
		}
	}
	
	function calcTimeDiff(d) {
		var now = new Date();
		
		var ms = (now - d); // milliseconds
		
		var sec = Math.floor(ms / 1000); //seconds
		
		var mins = Math.round(sec / 60); // minutes
		
		var hours = Math.floor(mins / 60); // hours
		
		var days = Math.floor(hours / 24); // days
		
		var weeks = Math.floor(days / 7); // weeks
		
		var years = now.getFullYear() - d.getFullYear(); // years
		
		var months = (years * 12) + (now.getMonth() - d.getMonth()); // months
		
		if(sec < 60){
			return sec+" seconds ago";
		}
		else if(mins < 60){
			return mins+" minutes ago";
		}
		else if(hours < 24){
			if(hours <= 1){
				return "1 hour ago";
			}
			else{
				return hours+" hours ago";
			}
		}
		else if(days < 7){
			if(days <= 1){
				return "1 day ago";
			}
			else{
				return days+" days ago";
			}
		}
		else if(weeks < 5){
			if(weeks <= 1){
				return "1 week ago";
			}
			else{
				return weeks+" weeks ago";
			}
		}
		else{
			if(months == 1){
				return "Last month";
			}
			else{
				return months+" months ago";
			}
		}
	}
	
	function setMarkerInfo(rowCopy, marker){	
		marker.addListener('mouseover', function() {
			infoWindow.setContent(rowCopy);
			infoWindow.open(map, marker);
		});
		marker.addListener('mouseout', function() {
			infoWindow.close();
		});
		marker.addListener('click', function() {
			infoWindow.setContent(rowCopy);
			infoWindow.open(map, marker);
		});
	}
	
	function getColourMMI(mmi){
		if(mmi < 3){
			return "#feedde";
		}
		else if(mmi == 3){
			return "#fdd0a2";
		}
		else if(mmi == 4){
			return "#fdae6b";
		}
		else if(mmi == 5){
			return "#fd8d3c";
		}
		else if(mmi == 6 || mmi == 7){
			return "#f16913";
		}
		else{
			return "#d94801";
		}
	}

	//calculate marker style
	function styleFeature(mag, lat, lng, quakeMMI) {
        var low = [151, 83, 34];   // color of mag 1.0
        var high = [5, 69, 54];  // color of mag 6.0 and above
        var minMag = 1.0;
        var maxMag = 6.0;

        // fraction represents where the value sits between the min and max
        var fraction = (Math.min(mag, maxMag) - minMag) /
            (maxMag - minMag);

        var color = interpolateHsl(low, high, fraction);
		
		if(colourScheme == 1){
			color = getColourMMI(quakeMMI);
		}

        return {
		icon: {
            path: google.maps.SymbolPath.CIRCLE,
            strokeWeight: 0.5,
            strokeColor: '#fff',
            fillColor: color,
            fillOpacity: 3 / mag,
            // while an exponent would technically be correct, quadratic looks nicer
            scale: Math.pow(mag, 2)/2
		},
		zIndex: Math.floor(mag),
		map: map,
		position: {lat: lat, lng: lng}
        };
	}

	//calculate colour of marker
	function interpolateHsl(lowHsl, highHsl, fraction) {
        var color = [];
        for (var i = 0; i < 3; i++) {
			// Calculate color based on the fraction.
			color[i] = (highHsl[i] - lowHsl[i]) * fraction + lowHsl[i];
        }

        return 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)';
	}
	
	</script>
	<script async="" defer="" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZ59X1xNVsFKPrHJ4-JG2osjcm6pfgpbE&amp;callback=initMap">
    </script>

</body>
</html>